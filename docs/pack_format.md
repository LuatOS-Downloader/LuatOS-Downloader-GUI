# 芯片支持包

芯片支持包用于芯片的`日志打印`、`下载`、`文件系统与固件合并`、`安装驱动`

由于许多芯片的日志打印与下载参数完全相同，所以芯片支持包支持**嵌套依赖**，以节省开发成本与硬盘与宽带占用

## 打包形式

每个芯片支持包为zip，根目录应当为一个文件夹（不能直接zip打开就是一堆文件）  
命名规则为`包名-支持系统-版本.zip`，其中

- `包名`原则上应为全小写，比如`air101`、`uart`等，不应当包含特殊字符，可以包含下划线
- `支持系统`由两部分组成：`系统`与`架构`，二者使用下划线分隔
  - `系统`包括： `win`、`linux`、`mac`
  - `架构`包括： `x86`、`x64`、`arm`、`arm64`。其中`x86`与`arm`后续可能考虑移除
- `版本`使用四个数字与小数点分隔，如`1.0.0.0`、`1.0.0.123`

## 文件夹结构

每个芯片支持包需要经过解压，放入`LuatOS_Downloader_Data/packs/`路径中，文件夹结构如下

- packs/ : LuatOS_Downloader的芯片支持包目录
  - air101-1.2.3.4/ : 某芯片支持包解压后的文件夹+版本号
    - config.toml : 某芯片支持包的配置信息
    - logger/ : 日志打印工具路径（该文件夹可不存在）
    - downloader/ : 下载烧录工具路径（该文件夹可不存在）
    - firmware_maker/ : 文件系统与固件合并工具路径（该文件夹可不存在）
    - firmware/ : 固件
    - driver/ : 驱动程序的路径（该文件夹可不存在）

不同芯片支持包均在同一同级目录，可以互相调用

## 配置信息

配置信息存储于`config.toml`中，文件格式如下：

```toml
[pack]
name = "包名"
version = "版本"
authors = ["aaa","bbb"]

#该包支持的系统架构
architecture = "win_x64"

#是否显示在支持的芯片列表中？
#某些单一功能的通用依赖包，不应显示在列表中
show = true

#依赖包列表
#软件会下载完所有依赖包，才会认为下载完成
[dependencies]
uart_log = "1.0.0.0" # 指定某个版本的包
uart_downloader = "*" # 任意版本的包都行，如果下载过任意版本的该包，就不会再下载
lfs_merge = "^" # 用当前最新版本的包
air101_soc = "0.0.1.3"
ch340_driver = "*"

#包功能重定向
#不使用该包自身路径下的工具，而使用指定依赖包的工具
#如不想重定向，则留空字符串
[redirect]
logger = "uart_log"
downloader = ""
firmware_maker = ""
firmware = "air101_soc"
driver = "ch340_driver"

#其他信息，给命令行参数使用
[others]
cmd_args = ["arg1","air101_soc/LuatOS-SoC_V0013_AIR101.soc"] # 如用不到，可为空数组
```

## 日志打印工具的交互逻辑

软件会调用串口工具目录下的`log.exe`进行各项操作（其他系统也使用exe作为拓展名，以便代码统一）

命令行传参格式为：

```cmd
log.exe 包名 操作命令 [设备id] [附加参数]
```

`log.exe`的返回值为普通的字符串，一行一条

### 包名

为依赖包配置信息`config.toml`中的`pack.name`包名

### 操作命令

- list 查看当前设备列表，返回值为一行一个设备名
- log 持续打印日志，直到强制停止exe

### 设备id

为上面`list`指令返回的可能的某一个设备

### 附加参数

为依赖包配置信息`config.toml`中的`others.cmd_args`数组内容，用于区分配置

## 下载烧录工具的交互逻辑

软件会调用串口工具目录下的`down.exe`进行各项操作（其他系统也使用exe作为拓展名，以便代码统一）

命令行传参格式为：

```cmd
down.exe 包名 操作命令 文件路径 设备id [附加参数]
```

`down.exe`的返回值为普通的字符串，一行一条，建议为纯英文  
下载进度以`[xx%]`开头，后方为下载内容解释  
若下载成功，须在退出程序前，输出以`[done]`开头的字符串  
若下载失败，须在退出程序前，输出以`[fail]`开头的字符串，后面可接失败原因

### 包名

为依赖包配置信息`config.toml`中的`pack.name`包名

### 操作命令

- script 只烧录脚本，烧录的文件由`文件系统与固件合并工具`合成而来
- firmware 烧录完整的固件，烧录的文件由`文件系统与固件合并工具`合成而来

### 文件路径

需要烧录的内容，原则上使用绝对路径，并且一般来说文件都会在`LuatOS_Downloader_Data/temp/`文件夹

### 设备id

为`日志打印工具`的`list`指令返回的可能的某一个设备

### 附加参数

为依赖包配置信息`config.toml`中的`others.cmd_args`数组内容，用于区分配置

## 文件系统与固件合并工具的交互逻辑

软件会调用串口工具目录下的`fm.exe`进行各项操作（其他系统也使用exe作为拓展名，以便代码统一）

命令行传参格式为：

```cmd
fm.exe 包名 操作命令 输入文件路径 输出文件路径 设备id [附加参数]
```

`fm.exe`的返回值为普通的字符串，一行一条，建议为纯英文  
生成进度以`[xx%]`开头，后方为生成内容解释  
若生成成功，须在退出程序前，输出以`[done]`开头的字符串  
若生成失败，须在退出程序前，输出以`[fail]`开头的字符串，后面可接失败原因

### 包名

为依赖包配置信息`config.toml`中的`pack.name`包名

### 操作命令

- script 只生成脚本文件系统打包
- firmware 生成完整的固件

### 输入文件路径

需要烧录的内容，原则上使用绝对路径，并且一般来说文件都会在`LuatOS_Downloader_Data/temp/`文件夹  
多个文件使用`,`逗号进行分隔，所有文件均为脚本文件  
固件路径的获取，可配合`firmware`文件夹内容与`config.toml`中的`others.cmd_args`参数配合获取

### 设备id

为`日志打印工具`的`list`指令返回的可能的某一个设备

### 附加参数

为依赖包配置信息`config.toml`中的`others.cmd_args`数组内容，用于区分配置

## 固件

只读，没有其他操作

## 驱动程序

没有交互，软件会直接打开这个文件夹，给用户自行选择操作方式

因为驱动程序安装所需系统权限不同，故不太方便进行统一的自动化操作
